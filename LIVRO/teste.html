<!DOCTYPE html>
<head>
    <title>E-Biblioteca - Teste</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/index">
    <link rel="stylesheet" href="/css/livro">
    <link rel="manifest" href="/manifest">
    <script src="https://kit.fontawesome.com/e77c01ed94.js" crossorigin="anonymous"></script>
</head>
<html lang="pt-br">
    <body>
        <nav>
            <button class="voltar" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i></button>
            <h1>EBJN</h1>
        </nav>
        <div class="blur" id="bookComplete">
            <div>
                <i class="fa-solid fa-circle-half-stroke fa-beat" aria-hidden="true"></i>
                <br>
                <span>0.0</span>
                <p>Parabens! VocÃª ganhou <span>0.0</span> PNTS! Continue assim.</p>
            </div>
        </div>
        <div id="flipbook">
            <div class="hard">
                <h1>Teste</h1>
                <br>
                De: Renan Augusto, Rosa Maria, Dafne
            </div>
            <div class="page"></div>
            <div class="page">
                <h3>Ola.</h3>
                <p>Este e uma biblioteca digital completamente gratuita.</p>
                <p>Queremos promover a leitura na escola e no sistema de ensino</p>
                <p>Espero que gostem da experiencia.</p>
            </div>
	        <div class="page"> Page 2 </div>
	        <div class="page"> Page 3 </div>
	        <div class="page"> Page 4 </div>
        </div>
        <button class="book-button" id="bButton" style="position: absolute;"><i class="fa-solid fa-book"></i></button>
        <div class="book-menu" id="bm">
            <button id="change-theme">Dark/Light</button>
        </div>
    </body>
</html>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="/js/turn"></script>
<script src="/js/book"></script>
<script>
    function getMultiValueCookie(name) {
    const cookieArray = document.cookie.split('; ');
    for (let i = 0; i < cookieArray.length; i++) {
        const cookie = cookieArray[i].split('=');
        if (cookie[0] === name) {
            return cookie[1].split(',');
        }
    }
    return null;
    }
    const user = getMultiValueCookie("username");
    if(user) {
        const id = user[0];
        const query = {
            operation: 'read-get',
            id: id,
            placeholder: 'teste'
        };
        fetch('/user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(query)
        }).then(response => response.json())
            .then(page => {
                console.log(page);
                if(page.page.length != 0) {
                    $("#flipbook").turn("page", page.page[0].page);
                }
        }).catch(error => console.error(error));
        let oldPage = $("#flipbook").turn("page");
        setInterval(() => {
            let actualPage = $("#flipbook").turn("page");
            if(actualPage == 6) {
                const query = {
                    operation: "read-finish",
                    medianInDays: 2,
                    id: id,
                    placeholder: "teste",
                    finishDate: new Date()
                };
                fetch('/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(query)
                }).then(response => response.json())
                    .then(data => {
                        console.log("Finishing ...");
                    console.log(data);
                    if(data.result = "sucessfuly") {
                        const pnts = document.querySelectorAll("span");
                        pnts.forEach(element => {
                            element.innerHTML = data.pnts;
                        });
                    }
                    document.getElementById("bookComplete").style.display = 'block';
                    setTimeout(() => window.location.assign('/'), 1000);
                }).catch(error => console.error(error));
            }
            if(actualPage != oldPage) {
                const data = {
                    operation: "read-update",
                    id: id,
                    pageNumber: actualPage,
                    placeholder: "teste",
                    date: new Date()
                };
                fetch('/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).catch(error => console.error(error));
                oldPage = actualPage;
            }
        }, 3000);
    }
</script>